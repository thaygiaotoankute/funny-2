<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OCR PDF với Server AI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        .container { max-width: 900px; }
        #resultContainer { display: none; }
        #resultText { height: 400px; overflow-y: auto; }
        #logArea { height: 150px; overflow-y: auto; background-color: #f8f9fa; padding: 10px; border-radius: 5px; }
        .progress { height: 25px; }
        .hardware-id-container { 
            border: 1px solid #dee2e6; 
            border-radius: 5px; 
            padding: 15px; 
            margin-bottom: 20px; 
        }
        .card-body img { max-width: 100%; }
        .social-icon {
            font-size: 1.5rem;
            margin-right: 10px;
            color: #6c757d;
            transition: color 0.3s;
        }
        .social-icon:hover {
            color: #0d6efd;
        }
        .tab-content {
            padding-top: 20px;
        }
        .author-card {
            border: none;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .author-card .card-header {
            background-color: #f8f9fa;
            border-bottom: none;
        }
        .nav-tabs .nav-link {
            font-weight: 500;
        }
        .nav-tabs .nav-link.active {
            border-bottom: 3px solid #0d6efd;
        }
    </style>
</head>
<body>
    <div class="container my-4">
        <h1 class="text-center mb-4">OCR PDF với Server AI</h1>
        
        <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="home-tab" data-bs-toggle="tab" data-bs-target="#home-tab-pane" type="button" role="tab" aria-controls="home-tab-pane" aria-selected="true">
                    <i class="bi bi-house-door"></i> Trang chính
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="author-tab" data-bs-toggle="tab" data-bs-target="#author-tab-pane" type="button" role="tab" aria-controls="author-tab-pane" aria-selected="false">
                    <i class="bi bi-person"></i> Thông tin tác giả
                </button>
            </li>
        </ul>
        
        <div class="tab-content" id="myTabContent">
            <!-- Tab 1: Main Application -->
            <div class="tab-pane fade show active" id="home-tab-pane" role="tabpanel" aria-labelledby="home-tab" tabindex="0">
                <!-- Hardware ID Section -->
                <div class="hardware-id-container">
                    <h4>Hardware ID</h4>
                    <div class="row mb-2">
                        <div class="col">
                            <input type="text" id="hardwareId" class="form-control" readonly>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">
                            <div id="activationStatus" class="alert alert-warning">
                                Trạng thái: CHƯA KÍCH HOẠT
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gemini API and Spelling Correction Section -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Tùy chọn sửa lỗi chính tả</h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col">
                                <label for="geminiApiKey" class="form-label">Gemini API Key:</label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="geminiApiKey" placeholder="Nhập Gemini API Key (không bắt buộc)">
                                    <button class="btn btn-outline-secondary" type="button" id="toggleGeminiKey">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                </div>
                                <div class="form-text">API key để sử dụng Gemini AI sửa lỗi chính tả tiếng Việt</div>
                            </div>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="spellingCorrection">
                            <label class="form-check-label" for="spellingCorrection">
                                Bật tính năng sửa lỗi chính tả (giới hạn 30 trang)
                            </label>
                        </div>
                    </div>
                </div>

                <!-- File Upload Section -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Chọn file PDF</h5>
                    </div>
                    <div class="card-body">
                        <form id="uploadForm">
                            <div class="mb-3">
                                <input class="form-control" type="file" id="pdfFile" accept=".pdf" disabled>
                                <div id="fileInfo" class="form-text">Chưa chọn file nào</div>
                            </div>
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary" id="processBtn" disabled>Xử lý OCR</button>
                            </div>
                        </form>

                        <div class="mt-3">
                            <div class="progress mb-2">
                                <div class="progress-bar" id="progressBar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                            </div>
                            <div id="statusText" class="text-center">Sẵn sàng</div>
                        </div>
                    </div>
                </div>

                <!-- Log Area -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Nhật ký hoạt động</h5>
                    </div>
                    <div class="card-body">
                        <div id="logArea"></div>
                    </div>
                </div>

                <!-- Results Section -->
                <div id="resultContainer" class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Kết quả OCR</h5>
                        <div>
                            <button id="btnViewImages" class="btn btn-info btn-sm me-2" disabled>Xem hình ảnh</button>
                            <div class="dropdown d-inline-block">
                              <button id="btnExport" class="btn btn-success btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" disabled>
                                Xuất dữ liệu
                              </button>
                              <ul class="dropdown-menu dropdown-menu-end">
                                <li><button class="dropdown-item" id="btnExportWordImage" type="button">
                                  <i class="bi bi-file-earmark-image me-2"></i>Word với hình ảnh
                                </button></li>
                                <li><button class="dropdown-item" id="btnExportWordEquation" type="button">
                                  <i class="bi bi-calculator me-2"></i>Word với công thức toán học
                                </button></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><button class="dropdown-item" id="btnExportZip" type="button">
                                  <i class="bi bi-file-earmark-zip me-2"></i>File ZIP đầy đủ
                                </button></li>
                              </ul>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <textarea id="resultText" class="form-control" readonly></textarea>
                    </div>
                </div>
            </div>
            
            <!-- Tab 2: Author Information -->
            <div class="tab-pane fade" id="author-tab-pane" role="tabpanel" aria-labelledby="author-tab" tabindex="0">
                <div class="card author-card">
                    <div class="card-header">
                        <h4 class="mb-0">Thông tin tác giả</h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4 text-center mb-4 mb-md-0">
                                <div class="p-3">
                                    <img src="https://ui-avatars.com/api/?name=Nguyễn+Hữu+Phúc&background=random&size=200" class="img-fluid rounded-circle mb-3" alt="Nguyễn Hữu Phúc">
                                    <h4>Nguyễn Hữu Phúc</h4>
                                    <p class="text-muted">Nhà phát triển ứng dụng AI OCR</p>
                                </div>
                            </div>
                            <div class="col-md-8">
                                <h5>Liên hệ</h5>
                                <ul class="list-group list-group-flush mb-4">
                                    <li class="list-group-item d-flex align-items-center">
                                        <i class="bi bi-phone me-3 text-primary"></i>
                                        <span>Zalo: <a href="https://zalo.me/0985692879" target="_blank">0985.692.879</a></span>
                                    </li>
                                    <li class="list-group-item d-flex align-items-center">
                                        <i class="bi bi-facebook me-3 text-primary"></i>
                                        <span>Facebook: <a href="https://www.facebook.com/nhphuclk" target="_blank">facebook.com/nhphuclk</a></span>
                                    </li>
                                    <li class="list-group-item d-flex align-items-center">
                                        <i class="bi bi-globe me-3 text-primary"></i>
                                        <span>Website: <a href="https://www.aiomtpremium.com" target="_blank">aiomtpremium.com</a></span>
                                    </li>
                                    <li class="list-group-item d-flex align-items-center">
                                        <i class="bi bi-youtube me-3 text-primary"></i>
                                        <span>Youtube: <a href="https://www.youtube.com/@aiomtpremium" target="_blank">youtube.com/@aiomtpremium</a></span>
                                    </li>
                                </ul>
                                
                                <h5>Về ứng dụng</h5>
                                <p>Ứng dụng OCR PDF với Server AI giúp nhận diện và trích xuất văn bản từ file PDF với độ chính xác cao, hỗ trợ nhận diện công thức toán học và hình ảnh.</p>
                                <p>Phiên bản này được triển khai trên nền tảng Vercel, sử dụng công nghệ AI tiên tiến từ Mistral AI để cung cấp kết quả OCR chất lượng cao.</p>
                                
                                <div class="d-flex mt-4">
                                    <a href="https://www.facebook.com/nhphuclk" target="_blank" class="social-icon" title="Facebook">
                                        <i class="bi bi-facebook"></i>
                                    </a>
                                    <a href="https://www.youtube.com/@aiomtpremium" target="_blank" class="social-icon" title="Youtube">
                                        <i class="bi bi-youtube"></i>
                                    </a>
                                    <a href="https://www.aiomtpremium.com" target="_blank" class="social-icon" title="Website">
                                        <i class="bi bi-globe"></i>
                                    </a>
                                    <a href="https://zalo.me/0985692879" target="_blank" class="social-icon" title="Zalo">
                                        <i class="bi bi-chat-dots"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Images Modal -->
        <div class="modal fade" id="imagesModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Hình ảnh từ OCR</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div id="imagesContainer"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Generate hardware ID using browser fingerprinting
        async function generateHardwareId() {
            const fpPromise = import('https://openfpcdn.io/fingerprintjs/v3')
                .then(FingerprintJS => FingerprintJS.load());
            
            const fp = await fpPromise;
            const result = await fp.get();

            // Get some additional browser info
            const cpuCores = navigator.hardwareConcurrency || '';
            const platform = navigator.platform || '';
            const userAgent = navigator.userAgent || '';
            
            // Create combined hardware info
            const hardwareInfo = {
                cpu_id: result.visitorId + cpuCores,
                bios_serial: platform + result.visitorId.substring(0, 8),
                motherboard_serial: userAgent.slice(0, 20) + result.visitorId.substring(8, 16)
            };
            
            // Get hardware ID from server
            try {
                const response = await fetch('/api/hardware-id', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(hardwareInfo)
                });
                
                const data = await response.json();
                if (data.success) {
                    document.getElementById('hardwareId').value = data.hardware_id;
                    updateActivationStatus(data.activated);
                } else {
                    logMessage('Lỗi: ' + data.error);
                }
            } catch (error) {
                logMessage('Lỗi khi lấy Hardware ID: ' + error);
            }
        }

        function updateActivationStatus(activated) {
            const statusElement = document.getElementById('activationStatus');
            const fileInput = document.getElementById('pdfFile');
            
            if (activated) {
                statusElement.className = 'alert alert-success';
                statusElement.textContent = 'Trạng thái: ĐÃ KÍCH HOẠT';
                fileInput.disabled = false;
                logMessage('Phần mềm đã được kích hoạt, sẵn sàng sử dụng');
            } else {
                statusElement.className = 'alert alert-warning';
                statusElement.textContent = 'Trạng thái: CHƯA KÍCH HOẠT';
                fileInput.disabled = true;
                logMessage('Vui lòng kích hoạt phần mềm trước khi sử dụng');
            }
        }

        function logMessage(message) {
            const logArea = document.getElementById('logArea');
            const timestamp = new Date().toLocaleTimeString();
            logArea.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            logArea.scrollTop = logArea.scrollHeight;
        }

        function updateProgress(percent, message) {
            const progressBar = document.getElementById('progressBar');
            const statusText = document.getElementById('statusText');
            
            progressBar.style.width = percent + '%';
            progressBar.textContent = percent + '%';
            progressBar.setAttribute('aria-valuenow', percent);
            
            if (message) {
                statusText.textContent = message;
                logMessage(message);
            }
        }

        // Hàm kiểm tra và khôi phục kết quả từ localStorage
        function checkForSavedResults() {
            try {
                const savedResultId = localStorage.getItem('lastResultId');
                const savedImageCount = localStorage.getItem('lastImageCount');
                const savedResultText = localStorage.getItem('lastResultText');
                
                if (savedResultId && savedResultText) {
                    logMessage('Đang khôi phục kết quả OCR từ phiên trước...');
                    
                    // Khôi phục kết quả
                    window.resultId = savedResultId;
                    window.imageCount = parseInt(savedImageCount || '0');
                    
                    // Hiển thị kết quả
                    document.getElementById('resultContainer').style.display = 'block';
                    document.getElementById('resultText').value = savedResultText;
                    
                    // Kích hoạt nút xuất Word và xem hình ảnh
                    document.getElementById('btnExport').disabled = false;
                    
                    if (window.imageCount > 0) {
                        document.getElementById('btnViewImages').disabled = false;
                        logMessage(`Khôi phục thành công với ${window.imageCount} hình ảnh`);
                    } else {
                        document.getElementById('btnViewImages').disabled = true;
                        logMessage('Khôi phục thành công nhưng không có hình ảnh');
                    }
                    
                    return true;
                }
            } catch (e) {
                logMessage('Không thể khôi phục kết quả trước đó: ' + e.message);
            }
            
            return false;
        }

        // Cập nhật thông tin file dựa trên tùy chọn sửa lỗi chính tả
        function updateFileInfo(file) {
            const fileInfo = document.getElementById('fileInfo');
            const spellingCorrection = document.getElementById('spellingCorrection').checked;
            
            if (file.type !== 'application/pdf') {
                fileInfo.textContent = 'Vui lòng chọn file PDF';
                return;
            }
            
            const pageLimit = spellingCorrection ? 30 : 100;
            const fileSizeMB = (file.size / 1024 / 1024).toFixed(2);
            fileInfo.textContent = `Đã chọn: ${file.name} (${fileSizeMB} MB, giới hạn ${pageLimit} trang${spellingCorrection ? ' khi bật sửa lỗi chính tả' : ''})`;
            
            logMessage(`File đã chọn: ${file.name} (${fileSizeMB} MB, giới hạn ${pageLimit} trang${spellingCorrection ? ' khi bật sửa lỗi chính tả' : ''})`);
        }

        async function processOCR(formData) {
            try {
                updateProgress(10, 'Đang tải file lên...');
                
                // Thêm Gemini API key và tùy chọn sửa lỗi chính tả vào formData
                const geminiApiKey = document.getElementById('geminiApiKey').value;
                const spellingCorrection = document.getElementById('spellingCorrection').checked;
                
                formData.append('gemini_api_key', geminiApiKey);
                formData.append('spelling_correction', spellingCorrection);
                
                if (spellingCorrection && geminiApiKey) {
                    logMessage('Đã bật tính năng sửa lỗi chính tả với Gemini API');
                } else if (spellingCorrection && !geminiApiKey) {
                    logMessage('Cảnh báo: Đã bật tính năng sửa lỗi chính tả nhưng chưa nhập Gemini API Key');
                }
                
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    updateProgress(100, 'Xử lý OCR hoàn tất thành công');
                    
                    // Hiển thị kết quả
                    document.getElementById('resultContainer').style.display = 'block';
                    document.getElementById('resultText').value = result.text;
                    
                    // Lưu kết quả ID để tải hình ảnh sau này
                    window.resultId = result.result_id;
                    window.imageCount = result.image_count;
                    
                    // Lưu vào localStorage để phòng trường hợp trang được làm mới
                    try {
                        localStorage.setItem('lastResultId', result.result_id);
                        localStorage.setItem('lastImageCount', result.image_count);
                        localStorage.setItem('lastResultText', result.text);
                        logMessage('Đã lưu kết quả vào bộ nhớ cục bộ');
                    } catch (e) {
                        logMessage('Không thể lưu kết quả vào bộ nhớ cục bộ: ' + e.message);
                    }
                    
                    // Kích hoạt nút xuất và xem hình ảnh
                    document.getElementById('btnExport').disabled = false;
                    
                    if (result.image_count > 0) {
                        document.getElementById('btnViewImages').disabled = false;
                        logMessage(`Tìm thấy ${result.image_count} hình ảnh trong kết quả OCR`);
                    } else {
                        document.getElementById('btnViewImages').disabled = true;
                        logMessage("Không tìm thấy hình ảnh trong kết quả OCR");
                    }
                    
                } else {
                    updateProgress(0, 'Lỗi: ' + result.error);
                }
            } catch (error) {
                updateProgress(0, 'Lỗi xử lý: ' + error);
            }
        }

        async function loadImages() {
            if (!window.resultId) {
                logMessage('Không có kết quả OCR để hiển thị hình ảnh');
                return;
            }
            
            try {
                // Hiển thị thông báo đang tải
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'text-center mb-4';
                loadingDiv.innerHTML = `
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Đang tải...</span>
                    </div>
                    <p>Đang tải hình ảnh...</p>
                `;
                
                const imagesContainer = document.getElementById('imagesContainer');
                imagesContainer.innerHTML = '';
                imagesContainer.appendChild(loadingDiv);
                
                logMessage('Đang tải thông tin hình ảnh từ kết quả OCR...');
                
                const response = await fetch(`/results/${window.resultId}`);
                const result = await response.json();
                
                if (result.success) {
                    imagesContainer.innerHTML = '';
                    
                    if (result.image_count === 0) {
                        imagesContainer.innerHTML = '<div class="text-center">Không có hình ảnh để hiển thị</div>';
                        return;
                    }
                    
                    logMessage(`Đã tìm thấy ${result.image_count} hình ảnh, đang tải...`);
                    
                    // Nếu API trả về danh sách ID hình ảnh
                    const imageIds = result.image_ids || [];
                    
                    if (imageIds.length > 0) {
                        // Hiển thị thông tin đang tải
                        const progressDiv = document.createElement('div');
                        progressDiv.className = 'progress mb-4';
                        progressDiv.innerHTML = `
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 id="imageLoadProgress" role="progressbar" 
                                 style="width: 0%" 
                                 aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                        `;
                        imagesContainer.appendChild(progressDiv);
                        
                        const progressBar = document.getElementById('imageLoadProgress');
                        
                        // Tải từng hình ảnh theo ID
                        for (let i = 0; i < imageIds.length; i++) {
                            const imageId = imageIds[i];
                            try {
                                const imageResponse = await fetch(`/images/${window.resultId}/${imageId}`);
                                
                                if (imageResponse.ok) {
                                    const blob = await imageResponse.blob();
                                    const imageUrl = URL.createObjectURL(blob);
                                    
                                    const imageDiv = document.createElement('div');
                                    imageDiv.className = 'mb-4';
                                    imageDiv.innerHTML = `
                                        <h5 class="text-primary">Hình ảnh: ${imageId}</h5>
                                        <div class="text-center">
                                            <img src="${imageUrl}" class="img-fluid mb-2" alt="${imageId}">
                                        </div>
                                    `;
                                    
                                    imagesContainer.appendChild(imageDiv);
                                    
                                    // Cập nhật tiến trình
                                    const percent = Math.round(((i + 1) / imageIds.length) * 100);
                                    progressBar.style.width = `${percent}%`;
                                    progressBar.textContent = `${percent}%`;
                                    progressBar.setAttribute('aria-valuenow', percent);
                                } else {
                                    const errorDiv = document.createElement('div');
                                    errorDiv.className = 'alert alert-warning mb-4';
                                    errorDiv.textContent = `Không thể tải hình ảnh: ${imageId}`;
                                    imagesContainer.appendChild(errorDiv);
                                }
                            } catch (e) {
                                logMessage(`Lỗi khi tải hình ảnh ${imageId}: ${e.message}`);
                            }
                        }
                        
                        // Xóa thanh tiến trình sau khi tải xong
                        imagesContainer.removeChild(progressDiv);
                        
                    } else {
                        // Cách cũ - Thử tải hình ảnh theo thứ tự
                        logMessage('Không có danh sách ID cụ thể, thử tải theo thứ tự');
                        
                        for (let i = 1; i <= result.image_count; i++) {
                            const imageId = `img-${i}.jpeg`;
                            try {
                                const imageResponse = await fetch(`/images/${window.resultId}/${imageId}`);
                                
                                if (imageResponse.ok) {
                                    const blob = await imageResponse.blob();
                                    const imageUrl = URL.createObjectURL(blob);
                                    
                                    const imageDiv = document.createElement('div');
                                    imageDiv.className = 'mb-4';
                                    imageDiv.innerHTML = `
                                        <h5 class="text-primary">Hình ảnh: ${imageId}</h5>
                                        <div class="text-center">
                                            <img src="${imageUrl}" class="img-fluid mb-2" alt="${imageId}">
                                        </div>
                                    `;
                                    
                                    imagesContainer.appendChild(imageDiv);
                                } else {
                                    const errorDiv = document.createElement('div');
                                    errorDiv.className = 'alert alert-warning mb-4';
                                    errorDiv.textContent = `Không thể tải hình ảnh: ${imageId}`;
                                    imagesContainer.appendChild(errorDiv);
                                }
                            } catch (e) {
                                logMessage(`Lỗi khi tải hình ảnh ${imageId}: ${e.message}`);
                            }
                        }
                    }
                    
                    if (imagesContainer.children.length === 0) {
                        imagesContainer.innerHTML = '<div class="alert alert-danger">Không thể tải hình ảnh nào</div>';
                    }
                    
                } else {
                    imagesContainer.innerHTML = `<div class="alert alert-danger">Lỗi khi tải hình ảnh: ${result.error}</div>`;
                    logMessage('Lỗi khi tải hình ảnh: ' + result.error);
                }
            } catch (error) {
                document.getElementById('imagesContainer').innerHTML = `<div class="alert alert-danger">Lỗi khi tải hình ảnh: ${error.message}</div>`;
                logMessage('Lỗi khi tải hình ảnh: ' + error.message);
            }
        }

        // Hàm xử lý xuất file
        function exportFile(exportType) {
            if (!window.resultId) {
                logMessage(`Không có kết quả OCR để xuất ${exportType}`);
                return;
            }
            
            // Hiển thị thông báo đang xử lý
            let exportDescription = '';
            switch(exportType) {
                case 'word-equation':
                    exportDescription = 'Word với công thức toán học';
                    updateProgress(30, `Đang chuẩn bị xuất ${exportDescription}...`);
                    break;
                case 'word-image':
                    exportDescription = 'Word với hình ảnh';
                    updateProgress(30, `Đang chuẩn bị xuất ${exportDescription}...`);
                    break;
                case 'zip':
                    exportDescription = 'file ZIP đầy đủ';
                    updateProgress(30, `Đang chuẩn bị xuất ${exportDescription}...`);
                    break;
            }
            
            // Hiển thị modal thông báo đang xử lý
            const processingModalDiv = document.createElement('div');
            processingModalDiv.className = 'modal fade show';
            processingModalDiv.id = 'processingModal';
            processingModalDiv.style.display = 'block';
            processingModalDiv.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            processingModalDiv.setAttribute('tabindex', '-1');
            
            let processingTitle = '';
            let processingDescription = '';
            let processingIcon = '';
            
            switch(exportType) {
                case 'word-equation':
                    processingTitle = 'Đang xuất Word với công thức toán học';
                    processingDescription = 'Hệ thống đang chuyển đổi công thức LaTeX thành equation Word.';
                    processingIcon = '<i class="bi bi-calculator text-primary mb-3" style="font-size: 2rem;"></i>';
                    break;
                case 'word-image':
                    processingTitle = 'Đang xuất Word với hình ảnh';
                    processingDescription = 'Hệ thống đang chèn hình ảnh vào tài liệu Word.';
                    processingIcon = '<i class="bi bi-file-earmark-image text-primary mb-3" style="font-size: 2rem;"></i>';
                    break;
                case 'zip':
                    processingTitle = 'Đang xuất file ZIP';
                    processingDescription = 'Hệ thống đang đóng gói tất cả dữ liệu vào file ZIP.';
                    processingIcon = '<i class="bi bi-file-earmark-zip text-primary mb-3" style="font-size: 2rem;"></i>';
                    break;
            }
            
            processingModalDiv.innerHTML = `
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-body text-center">
                            ${processingIcon ? processingIcon : '<div class="spinner-border text-primary mb-3" role="status"><span class="visually-hidden">Đang xử lý...</span></div>'}
                            <h5>${processingTitle}</h5>
                            <p>${processingDescription}</p>
                            <div id="exportTimer" class="text-muted mt-2">0:00</div>
                            <div class="progress mt-3">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                     style="width: 100%"></div>
                            </div>
                            <p class="small text-muted mt-2">
                                Quá trình này có thể mất một lúc, vui lòng đợi.
                            </p>
                            <button id="cancelExport" class="btn btn-sm btn-outline-secondary mt-2">Hủy</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(processingModalDiv);
            
            // Bắt đầu đếm thời gian
            let seconds = 0;
            const timerElement = document.getElementById('exportTimer');
            const timerInterval = setInterval(() => {
                seconds++;
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = seconds % 60;
                timerElement.textContent = `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
            }, 1000);
            
            // Xử lý sự kiện hủy
            document.getElementById('cancelExport').addEventListener('click', function() {
                clearInterval(timerInterval);
                document.body.removeChild(processingModalDiv);
                updateProgress(0, 'Đã hủy xuất file');
                logMessage(`Đã hủy quá trình xuất ${exportDescription}`);
                
                if (window.downloadFrame) {
                    try {
                        document.body.removeChild(window.downloadFrame);
                        window.downloadFrame = null;
                    } catch (e) {
                        console.error('Lỗi khi xóa frame:', e);
                    }
                }
            });
            
            // Tạo URL để tải về file - Thêm tham số type để backend biết cần xuất loại file nào
            const exportUrl = `/export/word/${window.resultId}?type=${exportType}`;
            
            // Tạo một iframe ẩn để tải file
            const downloadFrame = document.createElement('iframe');
            downloadFrame.style.display = 'none';
            window.downloadFrame = downloadFrame;
            document.body.appendChild(downloadFrame);
            
            // Thiết lập timeout (2 phút)
            const exportTimeout = setTimeout(() => {
                clearInterval(timerInterval);
                if (document.body.contains(processingModalDiv)) {
                    document.body.removeChild(processingModalDiv);
                }
                if (document.body.contains(downloadFrame)) {
                    document.body.removeChild(downloadFrame);
                }
                window.downloadFrame = null;
                
                updateProgress(0, 'Xuất file thất bại: Quá thời gian chờ');
                logMessage('Quá trình xuất đã quá thời gian chờ (120 giây). Vui lòng thử lại sau.');
                
            }, 120000); // 120 giây timeout (2 phút)
            
            // Theo dõi khi tải xong
            downloadFrame.onload = function() {
                clearTimeout(exportTimeout);
                clearInterval(timerInterval);
                
                try {
                    const frameContent = downloadFrame.contentDocument || downloadFrame.contentWindow.document;
                    const contentType = frameContent.contentType || '';
                    
                    if (frameContent && frameContent.body && frameContent.body.textContent) {
                        const responseText = frameContent.body.textContent;
                        
                        // Kiểm tra lỗi JSON
                        if (responseText.includes('"success":false') || responseText.includes('error')) {
                            try {
                                const errorData = JSON.parse(responseText);
                                throw new Error(errorData.error || 'Lỗi khi xử lý');
                            } catch (e) {
                                if (e instanceof SyntaxError) {
                                    // Không phải JSON - có thể là file đã tải về
                                    handleSuccessfulDownload(contentType, exportType);
                                } else {
                                    // Lỗi thực sự
                                    updateProgress(0, `Lỗi: ${e.message}`);
                                    logMessage(`Lỗi khi xuất ${exportDescription}: ${e.message}`);
                                }
                            }
                        } else {
                            // Thành công
                            handleSuccessfulDownload(contentType, exportType);
                        }
                    } else {
                        // File đã tải về (không đọc được nội dung)
                        handleSuccessfulDownload(contentType, exportType);
                    }
                } catch (e) {
                    // Lỗi cross-origin thường xảy ra khi file được tải về thành công
                    handleSuccessfulDownload('', exportType);
                }
                
                // Dọn dẹp
                if (document.body.contains(processingModalDiv)) {
                    document.body.removeChild(processingModalDiv);
                }
                
                setTimeout(() => {
                    if (document.body.contains(downloadFrame)) {
                        document.body.removeChild(downloadFrame);
                        window.downloadFrame = null;
                    }
                }, 1000);
            };
            
            // Xử lý lỗi
            downloadFrame.onerror = function() {
                clearTimeout(exportTimeout);
                clearInterval(timerInterval);
                
                updateProgress(0, 'Lỗi khi tải xuống file');
                logMessage(`Lỗi khi tải xuống ${exportDescription}`);
                
                if (document.body.contains(processingModalDiv)) {
                    document.body.removeChild(processingModalDiv);
                }
                if (document.body.contains(downloadFrame)) {
                    document.body.removeChild(downloadFrame);
                }
                window.downloadFrame = null;
            };
            
            // Hàm xử lý khi tải file thành công
            function handleSuccessfulDownload(contentType, exportType) {
                let successMessage = '';
                
                // Luôn nhận được file ZIP từ backend mới
                successMessage = `Đã xuất ${exportDescription} thành công`;
                
                // Nếu yêu cầu là word-equation hoặc word-image, hiển thị thông báo bổ sung
                if (exportType === 'word-equation' || exportType === 'word-image') {
                    showZipInfoModal(exportType);
                }
                
                updateProgress(100, successMessage);
                logMessage(successMessage);
            }
            
            // Hiển thị modal thông tin về file ZIP khi xuất Word
            function showZipInfoModal(exportType) {
                let modalTitle = 'Thông tin về file ZIP đã tải về';
                let modalBody = '';
                
                if (exportType === 'word-equation') {
                    modalBody = `
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle me-2"></i>
                            Hệ thống đã tạo file ZIP chứa Word với công thức toán học.
                        </div>
                        <p>File ZIP bao gồm:</p>
                        <ul>
                            <li><strong>ocr_result_*.docx</strong> - File Word đã tạo</li>
                            <li><strong>content.md</strong> - Nội dung định dạng Markdown</li>
                        </ul>
                        <p>Hãy giải nén file ZIP để xem nội dung.</p>
                    `;
                } else if (exportType === 'word-image') {
                    modalBody = `
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle me-2"></i>
                            Hệ thống đã tạo file Word với hình ảnh được chèn vào đúng vị trí.
                        </div>
                        <p>File ZIP bao gồm:</p>
                        <ul>
                            <li><strong>ocr_result_*.docx</strong> - File Word đã tạo với hình ảnh nhúng trực tiếp</li>
                        </ul>
                        <p>Hình ảnh đã được nhúng trực tiếp vào file Word mà không cần thư mục riêng.</p>
                    `;
                }
                
                const modalHtml = `
                    <div class="modal fade" id="zipInfoModal" tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">${modalTitle}</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    ${modalBody}
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Đã hiểu</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = modalHtml;
                document.body.appendChild(tempDiv.firstElementChild);
                
                const zipInfoModal = new bootstrap.Modal(document.getElementById('zipInfoModal'));
                zipInfoModal.show();
                
                document.getElementById('zipInfoModal').addEventListener('hidden.bs.modal', function() {
                    document.body.removeChild(this);
                });
            }
            
            // Bắt đầu tải xuống
            downloadFrame.src = exportUrl;
            updateProgress(50, `Đang xử lý ${exportDescription}...`);
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            generateHardwareId();
            
            const uploadForm = document.getElementById('uploadForm');
            const fileInput = document.getElementById('pdfFile');
            const processBtn = document.getElementById('processBtn');
            const fileInfo = document.getElementById('fileInfo');
            const btnViewImages = document.getElementById('btnViewImages');
            const imagesModal = new bootstrap.Modal(document.getElementById('imagesModal'));
            
            // Kiểm tra xem có kết quả được lưu từ trước không
            const hasRestoredResults = checkForSavedResults();
            if (hasRestoredResults) {
                logMessage('Đã khôi phục kết quả OCR từ phiên trước');
            }
            
            // Xử lý nút hiển thị/ẩn Gemini API key
            document.getElementById('toggleGeminiKey').addEventListener('click', function() {
                const geminiInput = document.getElementById('geminiApiKey');
                if (geminiInput.type === 'password') {
                    geminiInput.type = 'text';
                    this.innerHTML = '<i class="bi bi-eye-slash"></i>';
                } else {
                    geminiInput.type = 'password';
                    this.innerHTML = '<i class="bi bi-eye"></i>';
                }
            });

            // Xử lý checkbox sửa lỗi chính tả
            document.getElementById('spellingCorrection').addEventListener('change', function() {
                const fileInput = document.getElementById('pdfFile');
                if (fileInput.files && fileInput.files[0]) {
                    updateFileInfo(fileInput.files[0]);
                }
            });
            
            fileInput.addEventListener('change', function() {
                if (this.files && this.files[0]) {
                    const file = this.files[0];
                    updateFileInfo(file);
                    processBtn.disabled = false;
                } else {
                    fileInfo.textContent = 'Chưa chọn file nào';
                    processBtn.disabled = true;
                }
            });
            
            uploadForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                if (!fileInput.files || !fileInput.files[0]) {
                    logMessage('Vui lòng chọn file PDF trước');
                    return;
                }
                
                const formData = new FormData();
                formData.append('file', fileInput.files[0]);
                formData.append('hardware_id', document.getElementById('hardwareId').value);
                
                // Thêm Gemini API key và tính năng sửa lỗi chính tả
                const geminiApiKey = document.getElementById('geminiApiKey').value;
                const spellingCorrection = document.getElementById('spellingCorrection').checked;
                formData.append('gemini_api_key', geminiApiKey);
                formData.append('spelling_correction', spellingCorrection);
                
                if (spellingCorrection && !geminiApiKey) {
                    logMessage('Cảnh báo: Đã bật tính năng sửa lỗi chính tả nhưng chưa nhập Gemini API Key');
                }
                
                processBtn.disabled = true;
                updateProgress(0, 'Đang bắt đầu xử lý OCR...');
                
                processOCR(formData).finally(() => {
                    processBtn.disabled = false;
                });
            });
            
            btnViewImages.addEventListener('click', function() {
                loadImages().then(() => {
                    imagesModal.show();
                });
            });
            
            // Thêm event listener cho imagesModal để làm mới hình ảnh khi mở lại
            document.getElementById('imagesModal').addEventListener('show.bs.modal', function() {
                loadImages();
            });
            
            // Thêm event listener cho các nút xuất file
            document.getElementById('btnExportWordEquation').addEventListener('click', function() {
                exportFile('word-equation');
            });
            
            document.getElementById('btnExportWordImage').addEventListener('click', function() {
                exportFile('word-image');
            });
            
            document.getElementById('btnExportZip').addEventListener('click', function() {
                exportFile('zip');
            });
        });
    </script>
    <script src="https://openfpcdn.io/fingerprintjs/v3" async></script>
</body>
</html>
